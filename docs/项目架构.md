# 项目架构文档

## 概述

3D 五子棋是一个基于 Node.js + Express + Socket.IO + Three.js 的局域网对战游戏。项目采用模块化架构，前后端分离，代码结构清晰。

## 技术栈

### 后端
- **Node.js** - JavaScript 运行时
- **Express** - Web 服务器框架
- **Socket.IO** - WebSocket 实时通信

### 前端
- **Three.js** - 3D 图形渲染
- **原生 JavaScript** - 无框架依赖
- **CSS3** - 现代化 UI 样式

## 项目结构

```
gomoku3d/
├── server/                 # 服务端代码
│   ├── index.js           # 服务器入口文件
│   ├── game/              # 游戏逻辑模块
│   │   ├── GameLogic.js   # 胜负判断逻辑
│   │   └── Room.js        # 房间管理类
│   └── socket/            # Socket 通信模块
│       └── handlers.js    # Socket 事件处理器
├── public/                # 前端静态资源
│   ├── index.html         # 主页面（简化版）
│   ├── css/               # 样式文件
│   │   └── style.css      # 主样式表
│   └── js/                # JavaScript 模块
│       ├── main.js        # 应用入口
│       ├── state.js       # 游戏状态管理
│       ├── socket.js      # Socket 通信
│       ├── ui.js          # UI 控制
│       └── game3d.js      # 3D 渲染引擎
├── docs/                  # 项目文档
├── package.json           # 项目配置
└── README.md             # 项目说明

旧文件（已备份）:
├── server_old.js         # 原始服务端代码
└── public/index_old.html # 原始前端代码
```

## 模块说明

### 服务端模块

#### 1. server/index.js
- **职责**: 服务器启动入口
- **功能**: 
  - 创建 HTTP 服务器
  - 初始化 Socket.IO
  - 配置静态文件服务
  - 显示服务器地址信息

#### 2. server/game/GameLogic.js
- **职责**: 游戏规则逻辑
- **功能**:
  - 五子连珠胜负判断
  - 平局检测
  - 支持四个方向检测（横、竖、斜）

#### 3. server/game/Room.js
- **职责**: 房间状态管理
- **功能**:
  - 管理玩家列表
  - 维护棋盘状态
  - 记录落子历史
  - 回合切换控制

#### 4. server/socket/handlers.js
- **职责**: Socket 事件处理
- **功能**:
  - 房间创建/加入
  - 落子处理
  - 游戏重启
  - 聊天消息
  - 断线处理

### 前端模块

#### 1. public/js/main.js
- **职责**: 应用程序入口
- **功能**: 初始化应用，绑定事件监听器

#### 2. public/js/state.js
- **职责**: 全局状态管理
- **功能**: 
  - 管理游戏状态（玩家颜色、回合、房间号等）
  - 定义棋盘配置常量

#### 3. public/js/socket.js
- **职责**: Socket 通信封装
- **功能**:
  - 连接服务器
  - 发送/接收游戏事件
  - 房间操作（创建、加入）
  - 落子、重启、聊天

#### 4. public/js/ui.js
- **职责**: UI 界面控制
- **功能**:
  - 大厅界面管理
  - 游戏界面切换
  - 玩家信息显示
  - 聊天消息渲染
  - 游戏结束界面

#### 5. public/js/game3d.js
- **职责**: 3D 场景渲染
- **功能**:
  - Three.js 场景初始化
  - 棋盘、棋子 3D 建模
  - 光照和材质设置
  - 相机控制（旋转、缩放）
  - 鼠标/触摸交互
  - 落子动画

#### 6. public/css/style.css
- **职责**: 界面样式
- **功能**:
  - 毛玻璃效果
  - 渐变动画
  - 响应式布局
  - 移动端适配

## 数据流

### 游戏流程

```
1. 玩家 A 创建房间
   客户端 → create_room → 服务器
   服务器 → room_created → 客户端 A

2. 玩家 B 加入房间
   客户端 B → join_room → 服务器
   服务器 → room_joined → 客户端 B
   服务器 → opponent_joined → 客户端 A
   服务器 → game_start → 所有客户端

3. 玩家落子
   客户端 → place_stone → 服务器
   服务器验证 → stone_placed → 所有客户端
   服务器 → turn_change → 所有客户端

4. 游戏结束
   服务器检测胜负 → game_over → 所有客户端

5. 重新开始
   客户端 → restart_game → 服务器
   服务器 → game_restart → 所有客户端
```

## 设计原则

### 1. 关注点分离
- 前端按功能拆分为 5 个模块（状态、通信、UI、3D、入口）
- 后端按职责拆分为 3 层（入口、游戏逻辑、通信处理）

### 2. 单一职责
- 每个模块只负责一个明确的功能领域
- GameLogic 只做规则判断，不管理状态
- Room 只管理状态，不处理通信
- handlers 只处理通信，不包含业务逻辑

### 3. 依赖倒置
- handlers 依赖 Room 和 GameLogic 抽象
- 前端模块通过函数调用解耦，避免循环依赖

### 4. 代码规范
- JavaScript 文件不超过 300 行
- 每个文件夹不超过 8 个文件
- 使用简体中文注释
- UTF-8 编码

## 性能考虑

### 前端优化
- Three.js 渲染优化（阴影贴图 2048x2048）
- 粒子系统限制 200 个粒子
- 使用 requestAnimationFrame 动画循环
- 材质复用，减少 GPU 开销

### 后端优化
- 使用 Map 存储房间，O(1) 查找
- 胜负判断只检查最后落子周围，避免全盘扫描
- 断线自动清理房间，防止内存泄漏

## 扩展性

### 可扩展点
1. **游戏规则**: GameLogic 可扩展支持其他棋类
2. **房间管理**: 可添加观战、回放功能
3. **3D 效果**: 可增加更多视觉特效
4. **持久化**: 可接入数据库保存战绩

### 限制
- 当前为局域网对战，不支持互联网匹配
- 房间数据存储在内存，服务器重启会丢失
- 无用户认证系统

## 测试建议

### 功能测试
1. 创建房间 → 加入房间 → 正常对局
2. 边界测试：棋盘边缘落子
3. 异常测试：重复落子、非法位置
4. 断线重连测试

### 性能测试
1. 多房间并发测试
2. 长时间运行内存泄漏检测
3. 3D 渲染帧率监控

## 维护指南

### 常见问题
1. **端口被占用**: 修改 `server/index.js` 中的 PORT
2. **3D 渲染卡顿**: 降低粒子数量或阴影质量
3. **Socket 连接失败**: 检查防火墙设置

### 代码修改
- 修改游戏规则 → `server/game/GameLogic.js`
- 修改 UI 样式 → `public/css/style.css`
- 修改 3D 效果 → `public/js/game3d.js`
- 修改通信协议 → `server/socket/handlers.js` + `public/js/socket.js`
